
<!DOCTYPE html>
<html class="no-js" lang="zh">
  <head>
<meta charset="utf-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<link rel="alternate" href="https://www.desgard.com" hreflang="pt-BR">
<link href="http://gmpg.org/xfn/11" rel="profile">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="theme-color" content="#005344">
<title>Guardia · 瓜地</title>
<meta name="google-site-verification" content="zS1dSn20XtA4FJYEOQLXqI0boxZdMnJ2g3beje-cl20">
<meta name="description" content="I write many code to write less code.💻">
<meta name="keywords" content="">
<!-- Social: Facebook / Open Graph -->
<meta property="og:url" content="https://www.desgard.com/cocoapods-1/">
<meta property="og:title" content="CocoaPods 历险 - 总览 | Gua">
<meta property="og:description" content="I write many code to write less code.💻">
<meta property="og:site_name" content="Desgard_Duan">
<meta property="og:locale" content="pt_BR">
<meta property="og:type" content="website">
<meta property="og:author" content="https://www.facebook.com/desgard.duan">
<meta property="og:image" content="https://www.desgard.com">
<!-- Social: Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@nandomoreirame">
<meta name="twitter:domain" content="https://www.desgard.com">
<meta name="twitter:title" content="CocoaPods 历险 - 总览 | Gua">
<meta name="twitter:description" content="I write many code to write less code.💻">
<meta name="twitter:image:src" content="https://www.desgard.com">
<!-- Favicons -->
<link rel="apple-touch-icon" sizes="114x114" href="https://www.desgard.com/ico/apple-touch-icon-114.png">
<link rel="apple-touch-icon" sizes="72x72" href="https://www.desgard.com/ico/apple-touch-icon-72.png">
<link rel="apple-touch-icon" href="https://www.desgard.com/ico/apple-touch-icon-57.png">
<link rel="shortcut icon" href="https://www.desgard.com/ico/favicon.png">
<!-- rel prev and next -->
<!-- Canonical link tag -->
<link rel="canonical" href="https://www.desgard.com/cocoapods-1/">
<link rel="alternate" type="application/rss+xml" title="Gua" href="https://www.desgard.comfeed.xml">
<link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
<script src="/assets/js/main.js"></script>
<script src="/assets/js/jquery-3.1.js"></script>
<script src="/assets/js/jquery.rotate.js"></script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Website",
  "publisher": "www.desgard.com",
  "url": "http://www.desgard.com/",
  "description": "瓜地"
}
</script>
<script type="text/javascript">
  var disqus_shortname = 'desgard',
      baseurl          = '';
</script>
<!--
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-52446115-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c5a8123bc51782a3083a631ed9ff50e4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    }
  });
</script>
  </head>
  <body class=" cocoapods-1">
    <header class="header">
  <div class="container">
    <h1><a href="/"><strong>desgard</strong>.com</a></h1>
    <nav class="navbar">
      <ul>
        <!-- <li>
          <a href="/">
            <i class="fa fa-search"></i>
          </a>
        </li> -->
        <li>
          <a href="#!" data-modal="modalSearch" onclick="show_search_view(true)">
            <i class="fa fa-search">
            </i>
          </a>
        </li>
        <li><a href="/comment " target="_blank"><i class="fa fa-comments"></i></a></li>
        <li><a href="/feed.xml" target="_blank"><i class="fa fa-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>
    <main class="wrapper container" itemprop="mainContentOfPage" itemscope="itemscope" itemtype="http://schema.org/Blog">
      <article class="post" itemscope="itemscope" itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
  <header class="post-header">
    <h1>CocoaPods 历险 - 总览</h1>
    <div class="post-meta">
      <time datetime="2015-10-13">
        <i class="fa fa-calendar-o"></i> <time datetime="2019-03-16"> 2019-03-16
      </time>
      <span>
        <i class="fa fa-comments"></i> <a href="#container">Comment me!</a>
      </span>
      <span>
<!--
        <i class="fa fa-folder-open-o"></i> 
-->
      </span>
    </div>
  </header>
  <p>基本上所有的 iOSer 都是用过 <em>CocoaPods</em> 来管理 iOS 工程中的三方库，但是很少有系列文章来详细的解读 <em>CocoaPods</em>。笔者决定自行尝试一下。本文所有 <em>CocoaPods</em> 源码使用的是 1.5.3 版本。</p>
<h2 id="why-ruby">Why Ruby？</h2>
<p>笔者在日常工作中，在做一关于项目组件管理的效率工具，由于组内技术选型也确定了使用 Ruby 来开发，所以也花了一些时间入门了一下这门语言。纵观 <em>CocoaPods</em> 的代码，其中用到了很多 Ruby 的特性，并且 <em>CocoaPods</em> 的作者们也是深受 RoR 开发模式影响的一些工程师。为了整体把握 <em>CocoaPods</em> 这个项目，Ruby 这门脚本语言也建议去入门学习一下。</p>
<p>在 <em>CocoaPods</em> 中，很多代码片段用到了以下 Ruby 的特性或是 RoR 开发模式：</p>
<h3 id="1-eval-特性">1. <code class="highlighter-rouge">eval</code> 特性</h3>
<p>记得我第一次接触 <code class="highlighter-rouge">eval</code> 概念是在 SICP 中介绍的元语言抽象。例子讲述了用 Scheme 写出一个 Scheme 的解释器，其中依赖的<strong>自循环 Eval/Apply 解释器</strong>中，eval 过程即<strong>将一个表达式转换为取得其值的过程</strong>。</p>
<p>Ruby 也是具有 eval 的动态性，在 <strong>pry</strong> 中可以使用 <code class="highlighter-rouge">eval</code> 方法来测试它：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">eval</span> <span class="s2">"100 * (100 + 1) / 2"</span>
<span class="o">=&gt;</span> <span class="mi">5050</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">eval</span> <span class="s2">"puts 'Hello Ruby!'"</span>
<span class="no">Hello</span> <span class="no">Ruby</span><span class="o">!</span>
<span class="o">=&gt;</span> <span class="kp">nil</span></code></pre></figure>
<p>通过 <code class="highlighter-rouge">eval</code> 使得 Ruby 获得了更强大的动态能力，在运行时可以使用字符串来改变逻辑，而不是与传统的手动解析输入和输入语法树。</p>
<p>这个特性会在 <em>cocoapods-core</em> 中大量使用，用来解析 <code class="highlighter-rouge">Podfile</code>、<code class="highlighter-rouge">Podfile.lock</code> 和 <code class="highlighter-rouge">.spec</code> 文件。</p>
<h3 id="2-bundler-思想的铺垫">2. Bundler 思想的铺垫</h3>
<p>当笔者在入门 Ruby 开始学习写项目的开始，需要查询各种所需要的依赖库。而 <a href="https://rubygems.org/">rubygems.org</a> 简直就是一个宝地，它例如我们 iOS 开发中 <a href="https://cocoapods.org/">cocoapods.org</a> 的角色，用于托管一个个 Gem 组件，从而避免了重复造轮子。但是只是托管 Gem 组件是远远不够的，因为本地和远程服务器上的组件由于时间原因总会出现版本差异的问题。</p>
<p><strong>Bundler</strong> 诞生的原因之一就是需要解决依赖的版本问题。<em>Bundler</em> 使用了很多技巧性和启发式算法来解这个依赖图。从 <em>CocoaPods</em> 中的 <em><a href="https://github.com/CocoaPods/Molinillo">Molinillo</a></em> 算法中可以看出 <em>Bundler</em> 依赖图算法的影子，但是目前还不是特别的敏捷，个人觉得算法应该还有优化空间。另外，当 <em>Bundler</em> 每次运行后会通过一个 <code class="highlighter-rouge">Gemfile.lock</code> 来存储可行解，同样的 <em>CocoaPods</em> 中的 <code class="highlighter-rouge">Podfile.lock</code> 也是如此，通过 <em>YAML</em> 格式记录。这里推荐一篇文章： <a href="https://juejin.im/post/5c1fb3696fb9a049af6d4132">为什么我们要使用 RVM / Bundler</a>。</p>
<h3 id="3-强大的-plugin-开发能力">3. 强大的 plugin 开发能力</h3>
<h4 id="对-class-和-module-的扩展">对 Class 和 Module 的扩展</h4>
<p>这里我所理解的 plugin 开发也就是类似于我们在 iOS 中的 <strong>Category</strong> （Swift 的 <strong>Extension</strong>）。我们可以通过依赖库来对主仓 <em>CocoaPods</em> 的 Class 和 Module 进行动态操作。举个例子：</p>
<p>这个是在 <em>CocoaPods</em> 主仓中 <code class="highlighter-rouge">downloader.rb</code> 中的代码，其中定义了一些类方法：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># file: CocoaPods - cocoapods/downloader.rb</span>
<span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">module</span> <span class="nn">Downloader</span>
    <span class="nb">require</span> <span class="s1">'cocoapods/downloader/cache'</span>
    <span class="nb">require</span> <span class="s1">'cocoapods/downloader/request'</span>
    <span class="nb">require</span> <span class="s1">'cocoapods/downloader/response'</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span>
      <span class="n">request</span><span class="p">,</span>
      <span class="n">target</span><span class="p">,</span>
      <span class="ss">can_cache: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">cache_path: </span><span class="no">Config</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">cache_root</span> <span class="o">+</span> <span class="s1">'Pods'</span>
    <span class="p">)</span>
      <span class="c1"># ...</span>
      <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>
<p>但是在 <em><a href="https://github.com/CocoaPods/cocoapods-downloader">cocoapods-downloader</a></em> 模块中，<code class="highlighter-rouge">Downloader</code> 这个 module 的方法并不能满足全部需求，于是在 <code class="highlighter-rouge">api.rb</code> 中会看到这样的代码扩展：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># file: CocoaPods - cocoapods-downloader/api.rb</span>
<span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">module</span> <span class="nn">Downloader</span>
    <span class="k">module</span> <span class="nn">API</span>
      <span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">raise_on_failure</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
        <span class="c1"># ...</span>
      <span class="k">end</span>
      <span class="k">def</span> <span class="nf">check_exit_code!</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="c1"># ...</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>  </code></pre></figure>
<p>这也就好比在 iOS 开发中对某一个 Class 的 <em>Category</em> 扩展，可以为其增加方法、增加属性，甚至是重写方法。在 GitHub 有近百个关于 <em>CocoaPods</em> 的扩展和优化，这种代码随处可见。</p>
<p>值得一提的，在 Ruby 中使用类似于 ObjC 的 <em>Method Swizzling</em> 也随处可见。Ruby 中可简单的通过 <code class="highlighter-rouge">alias_method</code> 来对成员方法、类方法做到方法替换。</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">Test</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="k">def</span> <span class="nf">hello</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>     <span class="nb">p</span> <span class="s2">"hello"</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="k">end</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span> <span class="k">end</span>
<span class="o">=&gt;</span> <span class="ss">:hello</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">Test</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="kp">alias_method</span> <span class="ss">:hello_old</span><span class="p">,</span> <span class="ss">:hello</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="k">def</span> <span class="nf">hello</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>     <span class="nb">p</span> <span class="s2">"hello world"</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="k">end</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span> <span class="k">end</span>
<span class="o">=&gt;</span> <span class="ss">:hello</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="nb">test</span> <span class="o">=</span> <span class="no">Test</span><span class="p">.</span><span class="nf">new</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Test:0x007fca3eb1d158&gt;</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="nb">test</span><span class="p">.</span><span class="nf">hello</span>
<span class="s2">"hello world"</span>
<span class="o">=&gt;</span> <span class="s2">"hello world"</span></code></pre></figure>
<h4 id="bundler-对于-gem-开发的本地映射"><em>Bundler</em> 对于 Gem 开发的本地映射</h4>
<p>在 <em>CocoaPods</em> 中，我们可以看到它的 <code class="highlighter-rouge">gemfile</code> 的写法是这样：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">SKIP_UNRELEASED_VERSIONS</span> <span class="o">=</span> <span class="kp">false</span>
<span class="c1"># 声明 CocoaPods 对于 git 仓库的依赖关系。</span>
<span class="c1"># 兼容本地 git 仓库模式开发</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">cp_gem</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="s1">'master'</span><span class="p">,</span> <span class="ss">path: </span><span class="kp">false</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">gem</span> <span class="nb">name</span> <span class="k">if</span> <span class="no">SKIP_UNRELEASED_VERSIONS</span>
  <span class="c1"># 如果 path 参数为 true，那么将在 "../[repo_name]" 这个路径下搜索仓库</span>
  <span class="n">opts</span> <span class="o">=</span> <span class="k">if</span> <span class="n">path</span>
           <span class="p">{</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">"../</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
         <span class="k">else</span>
           <span class="c1"># 否则拼接 git 仓库地址获取</span>
           <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://github.com/CocoaPods/</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">.git"</span>
           <span class="p">{</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">,</span> <span class="ss">:branch</span> <span class="o">=&gt;</span> <span class="n">branch</span> <span class="p">}</span>
         <span class="k">end</span>
  <span class="c1"># 返回标准的 Gemfile Gem 导入格式</span>
  <span class="n">gem</span> <span class="nb">name</span><span class="p">,</span> <span class="n">opts</span>
<span class="k">end</span>
<span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">gemspec</span>
<span class="n">gem</span> <span class="s1">'json'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/segiddins/json.git'</span><span class="p">,</span> <span class="ss">:branch</span> <span class="o">=&gt;</span> <span class="s1">'seg-1.7.7-ruby-2.2'</span>
<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="c1"># 开发的 Gem 组件</span>
  <span class="n">cp_gem</span> <span class="s1">'claide'</span><span class="p">,</span>                <span class="s1">'CLAide'</span>
  <span class="n">cp_gem</span> <span class="s1">'cocoapods-core'</span><span class="p">,</span>        <span class="s1">'Core'</span>
  <span class="n">cp_gem</span> <span class="s1">'cocoapods-deintegrate'</span><span class="p">,</span> <span class="s1">'cocoapods-deintegrate'</span>
  <span class="n">cp_gem</span> <span class="s1">'cocoapods-downloader'</span><span class="p">,</span>  <span class="s1">'cocoapods-downloader'</span>
  <span class="n">cp_gem</span> <span class="s1">'cocoapods-plugins'</span><span class="p">,</span>     <span class="s1">'cocoapods-plugins'</span>
  <span class="n">cp_gem</span> <span class="s1">'cocoapods-search'</span><span class="p">,</span>      <span class="s1">'cocoapods-search'</span>
  <span class="n">cp_gem</span> <span class="s1">'cocoapods-stats'</span><span class="p">,</span>       <span class="s1">'cocoapods-stats'</span>
  <span class="n">cp_gem</span> <span class="s1">'cocoapods-trunk'</span><span class="p">,</span>       <span class="s1">'cocoapods-trunk'</span>
  <span class="n">cp_gem</span> <span class="s1">'cocoapods-try'</span><span class="p">,</span>         <span class="s1">'cocoapods-try'</span>
  <span class="n">cp_gem</span> <span class="s1">'molinillo'</span><span class="p">,</span>             <span class="s1">'Molinillo'</span>
  <span class="n">cp_gem</span> <span class="s1">'nanaimo'</span><span class="p">,</span>               <span class="s1">'Nanaimo'</span>
  <span class="n">cp_gem</span> <span class="s1">'xcodeproj'</span><span class="p">,</span>             <span class="s1">'Xcodeproj'</span>
  <span class="n">gem</span> <span class="s1">'cocoapods-dependencies'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0.beta.1'</span>
  <span class="n">gem</span> <span class="s1">'bacon'</span>
  <span class="n">gem</span> <span class="s1">'mocha'</span>
  <span class="n">gem</span> <span class="s1">'mocha-on-bacon'</span>
  <span class="n">gem</span> <span class="s1">'prettybacon'</span>
  <span class="n">gem</span> <span class="s1">'webmock'</span>
  <span class="c1"># 集成测试</span>
  <span class="n">gem</span> <span class="s1">'diffy'</span>
  <span class="n">gem</span> <span class="s1">'clintegracon'</span>
  <span class="c1"># 代码质量校验</span>
  <span class="n">gem</span> <span class="s1">'inch_by_inch'</span>
  <span class="n">gem</span> <span class="s1">'rubocop'</span>
  <span class="n">gem</span> <span class="s1">'danger'</span>
<span class="k">end</span>
<span class="n">group</span> <span class="ss">:debugging</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'cocoapods_debug'</span>
  <span class="n">gem</span> <span class="s1">'rb-fsevent'</span>
  <span class="n">gem</span> <span class="s1">'kicker'</span>
  <span class="n">gem</span> <span class="s1">'awesome_print'</span>
  <span class="n">gem</span> <span class="s1">'ruby-prof'</span><span class="p">,</span> <span class="ss">:platforms</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:ruby</span><span class="p">]</span>
<span class="k">end</span></code></pre></figure>
<p>在 <code class="highlighter-rouge">Gemfile</code> 中我们可以看到很多通过 <code class="highlighter-rouge">cp_gem</code> 装载的 Gem 库，并且如果发现有与 <em>CocoaPods</em> 项目目录同级的目录，则会使用对应的项目直接通过 Gem 加载。通过简单的目录分割和 <code class="highlighter-rouge">Gemfile</code> 管理，就实现了最基本又最直观的<strong>热插拔</strong>，对组件开发十分友好。所以你只要将多个仓库如下图方式排列，即可实现跨仓库组件开发：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># gua @ Guabook in ~/Desktop/cocoapod-dev [66:66:66]</span>
<span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">lrwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">gua</span>  <span class="n">staff</span>    <span class="mi">31</span> <span class="no">Jul</span> <span class="mi">30</span> <span class="mi">21</span><span class="p">:</span><span class="mi">34</span> <span class="no">CocoaPods</span>
<span class="n">lrwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">gua</span>  <span class="n">staff</span>    <span class="mi">26</span> <span class="no">Jul</span> <span class="mi">31</span> <span class="mi">13</span><span class="p">:</span><span class="mi">27</span> <span class="no">Core</span> 
<span class="n">lrwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">gua</span>  <span class="n">staff</span>    <span class="mi">31</span> <span class="no">Jul</span> <span class="mi">31</span> <span class="mi">10</span><span class="p">:</span><span class="mi">14</span> <span class="no">Molinillo</span> 
<span class="n">lrwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">gua</span>  <span class="n">staff</span>    <span class="mi">31</span> <span class="no">Aug</span> <span class="mi">15</span> <span class="mi">11</span><span class="p">:</span><span class="mi">32</span> <span class="no">Xcodeproj</span> 
<span class="n">lrwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">gua</span>  <span class="n">staff</span>    <span class="mi">42</span> <span class="no">Jul</span> <span class="mi">31</span> <span class="mi">10</span><span class="p">:</span><span class="mi">14</span> <span class="n">cocoapods</span><span class="o">-</span><span class="n">downloader</span> </code></pre></figure>
<p>当然选型为 Ruby 一定不仅仅有以下这些好处，有很多东西是我这个非专业 Rubyer 选手可以看出来的。如果有其他的优势可以帮我补充。</p>
<h2 id="组件构成和对应职责">组件构成和对应职责</h2>
<p>通过上面对于 <code class="highlighter-rouge">Gemfile</code> 的简单分析，可以看出 <em>CocoaPods</em> 不仅仅是一个仓库那么简单，它作为一个三方库版本管理工具，对自身组件的管理和组件化也是十分讲究的。我们继续来看这份 <code class="highlighter-rouge">Gemfile</code>：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># 开发的 Gem 组件</span>
<span class="c1"># CLAide 是一个命令的解析器</span>
<span class="c1">#通过简单的 API 提供命令的构造、参数解析、生成 help 等功能</span>
<span class="n">cp_gem</span> <span class="s1">'claide'</span><span class="p">,</span>                <span class="s1">'CLAide'</span>
<span class="c1"># Core 用于 CocoaPods 中模板文件的解析</span>
<span class="c1"># 包括 Podfile、podspec 文件，还包括所有的 .lock 文件中特殊的 YAML 文件</span>
<span class="n">cp_gem</span> <span class="s1">'cocoapods-core'</span><span class="p">,</span>        <span class="s1">'Core'</span>
<span class="c1"># cocoapods-deintegrate 用来从工程中删除所有的 CocoaPods 相关配置</span>
<span class="n">cp_gem</span> <span class="s1">'cocoapods-deintegrate'</span><span class="p">,</span> <span class="s1">'cocoapods-deintegrate'</span>
<span class="c1"># cocoapods-downloader CocoaPods 中的下载模块扩展</span>
<span class="c1"># 支持从 git, svn, hg, http, scp, bzr 多种协议，也有部分下载时候的优化策略</span>
<span class="n">cp_gem</span> <span class="s1">'cocoapods-downloader'</span><span class="p">,</span>  <span class="s1">'cocoapods-downloader'</span>
<span class="c1"># cocoapods-plugins 插件管理功能</span>
<span class="c1"># 其中有 `pod plugin` 全套命令，支持对于 CocoaPods 插件的列表一览(list)、搜索(search)、创建(create)功能</span>
<span class="n">cp_gem</span> <span class="s1">'cocoapods-plugins'</span><span class="p">,</span>     <span class="s1">'cocoapods-plugins'</span>
<span class="c1"># Pods 搜索工具</span>
<span class="c1"># 用来搜索 Pods 三方库</span>
<span class="n">cp_gem</span> <span class="s1">'cocoapods-search'</span><span class="p">,</span>      <span class="s1">'cocoapods-search'</span>
<span class="c1"># Pods 组件数据统计插件</span>
<span class="c1"># 展示下载量等相关统计方面的信息</span>
<span class="n">cp_gem</span> <span class="s1">'cocoapods-stats'</span><span class="p">,</span>       <span class="s1">'cocoapods-stats'</span>
<span class="c1"># 与 cocoapods.org 打通的命令行工具</span>
<span class="c1"># 用于查看个人用户信息、上传 spec 等操作</span>
<span class="n">cp_gem</span> <span class="s1">'cocoapods-trunk'</span><span class="p">,</span>       <span class="s1">'cocoapods-trunk'</span>
<span class="c1"># Pods 组件 Demo 工程快速预览</span>
<span class="n">cp_gem</span> <span class="s1">'cocoapods-try'</span><span class="p">,</span>         <span class="s1">'cocoapods-try'</span>
<span class="c1"># Pods 组件版本依赖仲裁算法</span>
<span class="n">cp_gem</span> <span class="s1">'molinillo'</span><span class="p">,</span>             <span class="s1">'Molinillo'</span>
<span class="c1"># ascii 编码的 plist 文件 Ruby 原生解析库</span>
<span class="n">cp_gem</span> <span class="s1">'nanaimo'</span><span class="p">,</span>               <span class="s1">'Nanaimo'</span>
<span class="c1"># 通过原生 Ruby 创建Xcode项目</span>
<span class="n">cp_gem</span> <span class="s1">'xcodeproj'</span><span class="p">,</span>             <span class="s1">'Xcodeproj'</span></code></pre></figure>
<p>通过查看 <code class="highlighter-rouge">Gemfile</code> 可以看出 CocoaPods 对于组件的拆分粒度是比较细微的，通过对各种组件的组合达到现在的完整版本。这些组件中，笔者也仅仅零散的看过一点，由于组件群过于庞大。但是都能达到拆开去使用的程度。</p>
<p><img src="../assets/images/blog/15331754438882/15528105632230.jpg" alt="" /></p>
<p>例如，如果当对<strong>构建 Xcode 工程</strong>有校本化处理需求的时候，可以使用 <em>Xcodeproj</em> 来打开、修改、保存一个工程。例如使用 <code class="highlighter-rouge">xcodeproj</code> 来查看 <code class="highlighter-rouge">Sepicat</code> 项目的一些信息：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">'xcodeproj'</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">XCODEPROJ_PATH</span> <span class="o">=</span> <span class="no">Pathname</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"/Users/gua/Desktop/git/Sepicat-dev/Sepicat/Sepicat/Sepicat.xcodeproj"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Pathname:/Users/gua/Desktop/git/Sepicat-dev/Sepicat/Sepicat/Sepicat.xcodeproj&gt;</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">project</span> <span class="o">=</span> <span class="no">Xcodeproj</span><span class="o">::</span><span class="no">Project</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="no">XCODEPROJ_PATH</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Xcodeproj::Project:0x3fe51f622d2c&gt;</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">project</span><span class="p">.</span><span class="nf">targets</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="c1">#&lt;Xcodeproj::Project::Object::PBXNativeTarget:0x3fe51f498e5c&gt;, #&lt;Xcodeproj::Project::Object::PBXNativeTarget:0x3fe51fc96410&gt;]</span>
<span class="p">[</span><span class="no">I</span><span class="err">'</span><span class="n">m</span> <span class="mi">5</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">project</span><span class="p">.</span><span class="nf">to_hash</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="s2">"objects"</span><span class="o">=&gt;</span>
  <span class="p">{</span><span class="s2">"D59E24B31FB8861200B00B8C"</span><span class="o">=&gt;</span>
    <span class="p">{</span><span class="s2">"isa"</span><span class="o">=&gt;</span><span class="s2">"PBXProject"</span><span class="p">,</span>
     <span class="s2">"attributes"</span><span class="o">=&gt;</span>
      <span class="p">{</span><span class="s2">"LastSwiftUpdateCheck"</span><span class="o">=&gt;</span><span class="s2">"0910"</span><span class="p">,</span>
       <span class="s2">"LastUpgradeCheck"</span><span class="o">=&gt;</span><span class="s2">"0910"</span><span class="p">,</span>
       <span class="s2">"ORGANIZATIONNAME"</span><span class="o">=&gt;</span><span class="s2">"Desgard_Duan"</span><span class="p">,</span>
       <span class="s2">"TargetAttributes"</span><span class="o">=&gt;</span>
        <span class="p">{</span><span class="s2">"D59E24BA1FB8861200B00B8C"</span><span class="o">=&gt;</span>
          <span class="p">{</span><span class="s2">"CreatedOnToolsVersion"</span><span class="o">=&gt;</span><span class="s2">"9.1"</span><span class="p">,</span>
           <span class="s2">"LastSwiftMigration"</span><span class="o">=&gt;</span><span class="s2">"0920"</span><span class="p">,</span>
           <span class="s2">"ProvisioningStyle"</span><span class="o">=&gt;</span><span class="s2">"Automatic"</span><span class="p">},</span>
         <span class="s2">"D59E24CE1FB8861200B00B8C"</span><span class="o">=&gt;</span>
          <span class="p">{</span><span class="s2">"CreatedOnToolsVersion"</span><span class="o">=&gt;</span><span class="s2">"9.1"</span><span class="p">,</span>
           <span class="s2">"ProvisioningStyle"</span><span class="o">=&gt;</span><span class="s2">"Automatic"</span><span class="p">,</span>
           <span class="s2">"TestTargetID"</span><span class="o">=&gt;</span><span class="s2">"D59E24BA1FB8861200B00B8C"</span><span class="p">}}},</span>
           <span class="o">...</span></code></pre></figure>
<p>这里我调用了 <code class="highlighter-rouge">Project</code> 这个 Class 的 <code class="highlighter-rouge">to_hash</code> 方法，它可以讲 <code class="highlighter-rouge">xcodeproj</code> 所有的环境变量以 Hash 方式返回并输出。当然，<em>Xcodeproj</em> 功能不止于此，在后续的系列文章中会有更多的使用方法。这里仅仅是来展示，所有的 Gem 组件是可以单独抽离出来使用的。</p>
<h2 id="从一次-install-命令来初探-cocoapods-源码">从一次 Install 命令来初探 CocoaPods 源码</h2>
<h3 id="命令入口">命令入口</h3>
<p><code class="highlighter-rouge">pod install</code> 其实是 iOS 开发者在学习 CocoaPods 时学习的第一个命令，虽然网上已经有很多关于 <code class="highlighter-rouge">pod install</code> 的原理解析，但是作为系列第一篇，这个分析仍旧重要。我们打开终端到项目中的 <code class="highlighter-rouge">Podfile</code> 所在目录下，输入 <code class="highlighter-rouge">pod install</code>：</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pod <span class="nb">install</span></code></pre></figure>
<p>每次当输入一个 <code class="highlighter-rouge">pod xxx</code> 命令的时候，首先系统会调用这个 <code class="highlighter-rouge">pod</code> 命令。所有的命令都是在 <code class="highlighter-rouge">/bin</code> 目录下存放的脚本，当然 Ruby 环境的也不例外。我们可以通过 <code class="highlighter-rouge">command which pod</code> 来查看命令所在位置：</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">command </span>which pod
/Users/gua/.rvm/gems/ruby-2.4.1/bin/pod</code></pre></figure>
<p>出现 <code class="highlighter-rouge">/Users/gua/.rvm/gems/ruby-2.4.1/bin/pod</code> 而不是 <code class="highlighter-rouge">/usr/local/bin/pod</code> 的原因是因为我电脑中的 Ruby 版本是使用 <em>RVM</em> 进行版本控制的，所以会装在这么一个冗长的目录下。我们来看一下这个入口脚本执行了什么：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># pod</span>
<span class="c1">#!/usr/bin/env ruby_executable_hooks</span>
<span class="c1">#</span>
<span class="c1"># This file was generated by RubyGems.</span>
<span class="c1">#</span>
<span class="c1">#'cocoapods' 做为 Gem 组件被安装</span>
<span class="c1"># 这个脚本做为入口文件来唤醒 cocoapods </span>
<span class="c1">#</span>
<span class="nb">require</span> <span class="s1">'rubygems'</span>
<span class="n">version</span> <span class="o">=</span> <span class="s2">"&gt;= 0.a"</span>
<span class="k">if</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">first</span>
  <span class="n">str</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">first</span>
  <span class="c1"># "BINARY" 是 ASCII-8BIT 别名</span>
  <span class="n">str</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="nf">dup</span><span class="p">.</span><span class="nf">force_encoding</span><span class="p">(</span><span class="s2">"BINARY"</span><span class="p">)</span> <span class="k">if</span> <span class="n">str</span><span class="p">.</span><span class="nf">respond_to?</span> <span class="ss">:force_encoding</span>
  <span class="c1"># \A 代表输入的开始位置，\z 代表输入的结束</span>
  <span class="k">if</span> <span class="n">str</span> <span class="o">=~</span> <span class="sr">/\A_(.*)_\z/</span> <span class="n">and</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">correct?</span><span class="p">(</span><span class="vg">$1</span><span class="p">)</span> <span class="k">then</span>
    <span class="n">version</span> <span class="o">=</span> <span class="vg">$1</span>
    <span class="c1"># shift 拿出第一个元素并移除</span>
    <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">if</span> <span class="no">Gem</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:activate_bin_path</span><span class="p">)</span>
  <span class="nb">load</span> <span class="no">Gem</span><span class="p">.</span><span class="nf">activate_bin_path</span><span class="p">(</span><span class="s1">'cocoapods'</span><span class="p">,</span> <span class="s1">'pod'</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">gem</span> <span class="s2">"cocoapods"</span><span class="p">,</span> <span class="n">version</span>
  <span class="nb">load</span> <span class="no">Gem</span><span class="p">.</span><span class="nf">bin_path</span><span class="p">(</span><span class="s2">"cocoapods"</span><span class="p">,</span> <span class="s2">"pod"</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>
<p>入口中将命令的执行指向了 Gem 组件的 Path 中，这样就找到了 <em>CocoaPods</em> 的入口脚本，即在 <code class="highlighter-rouge">cocoapods/bin</code> 目录下的 <code class="highlighter-rouge">pod</code>。</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># ... 忽略一些对于编码处理的代码</span>
<span class="nb">require</span> <span class="s1">'cocoapods'</span>
<span class="c1"># 这里我手动输出一下调用栈，来关注一下</span>
<span class="nb">puts</span> <span class="nb">caller</span>
<span class="k">if</span> <span class="n">profile_filename</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'PROFILE'</span><span class="p">]</span>
  <span class="nb">require</span> <span class="s1">'ruby-prof'</span>
  <span class="n">reporter</span> <span class="o">=</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">profile_extname</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">extname</span><span class="p">(</span><span class="n">profile_filename</span><span class="p">))</span>
    <span class="k">when</span> <span class="s1">'.txt'</span>
      <span class="no">RubyProf</span><span class="o">::</span><span class="no">FlatPrinterWithLineNumbers</span>
    <span class="k">when</span> <span class="s1">'.html'</span>
      <span class="no">RubyProf</span><span class="o">::</span><span class="no">GraphHtmlPrinter</span>
    <span class="k">when</span> <span class="s1">'.callgrind'</span>
      <span class="no">RubyProf</span><span class="o">::</span><span class="no">CallTreePrinter</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">"Unknown profiler format indicated by extension: </span><span class="si">#{</span><span class="n">profile_extname</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">profile_filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
    <span class="c1"># 实例化一个 Pods::Command 对象，并进入主流程</span>
    <span class="n">reporter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">RubyProf</span><span class="p">.</span><span class="nf">profile</span> <span class="p">{</span> <span class="no">Pod</span><span class="o">::</span><span class="no">Command</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="no">ARGV</span><span class="p">)</span> <span class="p">}).</span><span class="nf">print</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">else</span>
  <span class="c1"># 实例化一个 Pods::Command 对象，并进入主流程</span>
  <span class="no">Pod</span><span class="o">::</span><span class="no">Command</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="no">ARGV</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>
<p>调用栈输出了两个方法：</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/Users/gua/.rvm/gems/ruby-2.4.1/bin/pod:23:in <span class="sb">`</span>load<span class="s1">'
/Users/gua/.rvm/gems/ruby-2.4.1/bin/pod:23:in `&lt;main&gt;'</span>
/Users/gua/.rvm/gems/ruby-2.4.1/bin/ruby_executable_hooks:24:in <span class="sb">`</span><span class="nb">eval</span><span class="s1">'
/Users/gua/.rvm/gems/ruby-2.4.1/bin/ruby_executable_hooks:24:in `&lt;main&gt;'</span></code></pre></figure>
<p><code class="highlighter-rouge">ruby_executable_hooks</code> 通过 <code class="highlighter-rouge">bin</code> 目录下的 <code class="highlighter-rouge">pod</code> 入口唤醒，再通过 <code class="highlighter-rouge">eval</code> 的手段调起我们需要的 CocoaPods 工程。这是 <code class="highlighter-rouge">Bundler</code> 的自身行为。</p>
<p>在入口的最后部分，发现通过调用 <code class="highlighter-rouge">Pod::Command.run(ARGV)</code>，实例化了一个 <code class="highlighter-rouge">CLAide::Command</code> 对象，于是用户输入的命令及层数从此进入<strong>CLAide 解析阶段</strong>。这里不对 <strong>CLAide</strong> 这个命令解析工具做过多的分析，这个是后面系列文章的内容，我们仅仅知道，它是一个<strong>根据继承来自动生成命令层级的命令解析工具，每次命令的执行，其实是对应到具体 Class 的 <code class="highlighter-rouge">run</code> 方法</strong>。</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Pod</span>
<span class="c1"># hello</span>
  <span class="k">class</span> <span class="nc">Command</span>
    <span class="k">class</span> <span class="nc">Install</span> <span class="o">&lt;</span> <span class="no">Command</span>
      <span class="c1"># .. 省略很多参数定义</span>
      <span class="k">def</span> <span class="nf">run</span>
        <span class="c1"># 判断是否存在 Podfile 文件</span>
        <span class="c1"># 不存在直接回抛出 "No `Podfile' found in the project directory." 的警告，终止程序</span>
        <span class="n">verify_podfile_exists!</span>
        <span class="c1"># 从 Config 中获取一个 Instraller 实例</span>
        <span class="n">installer</span> <span class="o">=</span> <span class="n">installer_for_config</span>
        <span class="c1"># 默认是不执行 update</span>
        <span class="n">installer</span><span class="p">.</span><span class="nf">repo_update</span> <span class="o">=</span> <span class="n">repo_update?</span><span class="p">(</span><span class="ss">:default</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">)</span>
        <span class="n">installer</span><span class="p">.</span><span class="nf">update</span> <span class="o">=</span> <span class="kp">false</span>
        <span class="n">installer</span><span class="p">.</span><span class="nf">deployment</span> <span class="o">=</span> <span class="vi">@deployment</span>
        <span class="c1"># install 的真正过程</span>
        <span class="n">installer</span><span class="p">.</span><span class="nf">install!</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>
<p>首先根据上面的描述，<code class="highlighter-rouge">Install</code> 是继承于 <code class="highlighter-rouge">Command</code> 命令的，所以对应的命令为 <code class="highlighter-rouge">pod install</code>。<code class="highlighter-rouge">pod install</code> 过程是依赖于 <code class="highlighter-rouge">Podfile</code> 文件的，所以在入口处会做检测，这个错误信息也是我们经常见到的错误信息之一。在 <code class="highlighter-rouge">installer</code> 实例组装完成之后，调用其 <code class="highlighter-rouge">installer.install!</code> 方法，这时候才进入了我们 <code class="highlighter-rouge">pod install</code> 命令的主体部分。</p>
<h3 id="执行功能主体">执行功能主体</h3>
<p>接着 <code class="highlighter-rouge">installer.install!</code>，发现其实这也是一个高度封装的入口方法，具体代码如下：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">install!</span>
  <span class="c1"># 检测是否在 Pods 内部，如果不是则做一些 install 前准备工作</span>
  <span class="n">prepare</span>
  <span class="c1"># 依赖图的解析</span>
  <span class="n">resolve_dependencies</span>
  <span class="c1"># 依赖下载</span>
  <span class="n">download_dependencies</span>
  <span class="c1"># 检验所有的 targets</span>
  <span class="n">validate_targets</span>
  <span class="c1"># 生成外层项目</span>
  <span class="n">generate_pods_project</span>
  <span class="k">if</span> <span class="n">installation_options</span><span class="p">.</span><span class="nf">integrate_targets?</span>
    <span class="c1"># 集成用户配置，读取依赖项，使用 xcconfig 来配置</span>
    <span class="n">integrate_user_project</span>
  <span class="k">else</span>
    <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Skipping User Project Integration'</span>
  <span class="k">end</span>
  <span class="c1"># 执行任何 install 后的操作，例如一些 plugin 可以插在这里</span>
  <span class="n">perform_post_install_actions</span>
<span class="k">end</span></code></pre></figure>
<h4 id="install-环境准备流程---prepare">Install 环境准备流程 - <code class="highlighter-rouge">prepare</code></h4>
<p>先来看 <code class="highlighter-rouge">prepare</code> 方法的实现：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">prepare</span>
  <span class="c1"># 如果检测出当前目录是 Pods，直接 raise 终止</span>
  <span class="k">if</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="n">sandbox</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">to_path</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s1">'Command should be run from a directory outside Pods directory.'</span>
    <span class="n">message</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n\n\t</span><span class="s2">Current directory is </span><span class="si">#{</span><span class="no">UI</span><span class="p">.</span><span class="nf">path</span><span class="p">(</span><span class="no">Pathname</span><span class="p">.</span><span class="nf">pwd</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="n">message</span>
  <span class="k">end</span>
  <span class="no">UI</span><span class="p">.</span><span class="nf">message</span> <span class="s1">'Preparing'</span> <span class="k">do</span>
    <span class="c1"># 如果 lock 文件的 CocoaPods 版本和当前版本不同，需要使用新版本依赖的 xcodeproj 对工程文件进行更新</span>
    <span class="n">deintegrate_if_different_major_version</span>
    <span class="c1"># 对 sandbox(Pods) 目录建立子目录结构</span>
    <span class="n">sandbox</span><span class="p">.</span><span class="nf">prepare</span>
    <span class="c1"># 检测 PluginManager 是否有 pre-install 的 plugin</span>
    <span class="n">ensure_plugins_are_installed!</span>
    <span class="c1"># 执行插件中 pre-install 的所有 hooks 方法</span>
    <span class="n">run_plugins_pre_install_hooks</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>
<p>在 <code class="highlighter-rouge">prepare</code> 阶段会将 <code class="highlighter-rouge">pod install</code> 的准备工作完成，包括<strong>版本一致性</strong>、<strong>目录接口</strong>以及 <em>pre-install</em> 的装载插件脚本全部取出。之后我们来到 <em>CocoaPods</em> 中最复杂的依赖解析环节。</p>
<h4 id="依赖解析流程---resolve_dependencies">依赖解析流程 - <code class="highlighter-rouge">resolve_dependencies</code></h4>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">resolve_dependencies</span>
  <span class="c1"># 获取 Sources</span>
  <span class="n">plugin_sources</span> <span class="o">=</span> <span class="n">run_source_provider_hooks</span>
  <span class="c1"># 创建一个 Analyzer</span>
  <span class="c1"># Analyzer 是通过分析 Podfile, Podfile.lock, 沙盒中的 manifest 从而生成了一张依赖关系表</span>
  <span class="n">analyzer</span> <span class="o">=</span> <span class="n">create_analyzer</span><span class="p">(</span><span class="n">plugin_sources</span><span class="p">)</span>
  <span class="c1"># 如果带有 repo_update 标记</span>
  <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Updating local specs repositories'</span> <span class="k">do</span>
    <span class="c1"># 执行 Analyzer 的更新 Repo 操作</span>
    <span class="n">analyzer</span><span class="p">.</span><span class="nf">update_repositories</span>
  <span class="k">end</span> <span class="k">if</span> <span class="n">repo_update?</span>
  <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Analyzing dependencies'</span> <span class="k">do</span>
    <span class="c1"># 从 analyzer 取出最新的分析结果</span>
    <span class="n">analyze</span><span class="p">(</span><span class="n">analyzer</span><span class="p">)</span>
    <span class="c1"># 个人调试使用，用于输出所有的 dependencies 缓存列表</span>
    <span class="vi">@analysis_result</span><span class="p">.</span><span class="nf">podfile_dependency_cache</span><span class="p">.</span><span class="nf">podfile_dependencies</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="nb">p</span> <span class="n">item</span> <span class="p">}</span>
    <span class="c1"># p @analysis_result.podfile_state</span>
    <span class="c1"># p @analysis_result.sandbox_state</span>
    <span class="vi">@analysis_result</span><span class="p">.</span><span class="nf">specs_by_target</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
      <span class="vi">@analysis_result</span><span class="p">.</span><span class="nf">specs_by_target</span><span class="p">[</span><span class="n">item</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">sub_item</span><span class="o">|</span>
        <span class="nb">p</span> <span class="n">sub_item</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1"># 拼写错误降级识别，白名单过滤</span>
    <span class="n">validate_build_configurations</span>
    <span class="c1"># 清除并重新生成目录，更新 Pods 目录结构</span>
    <span class="n">clean_sandbox</span>
  <span class="k">end</span>
  <span class="n">analyzer</span>
<span class="k">end</span></code></pre></figure>
<p>依赖解析过程我们暂时只要知道通过 <code class="highlighter-rouge">Podfile</code>、<code class="highlighter-rouge">Podfile.lock</code>、<code class="highlighter-rouge">manifest</code> 文件来生成一个 <em>Analyzer</em> 对象。<em>Analyzer</em> 内部会使用 <em>Molinillo</em> （具体的是 <code class="highlighter-rouge">Molinillo::DependencyGraph</code> 图算法）从而得到解析结果。我们可以分别输出 <code class="highlighter-rouge">@analysis_result</code> 的 <code class="highlighter-rouge">podfile_dependency_cache.podfile_dependencies</code> 来查看 <em>Podfile</em> 文件的依赖分析结果，也可以从 <code class="highlighter-rouge">specs_by_target</code> 来查看各个 <em>target</em> 相关的 specs。总之，通过 <em>Analyzer</em> 能获取到很多关于依赖的信息。</p>
<p>另外，需要区分的是，在 <code class="highlighter-rouge">pod install</code> 的过程有有一个 <em>pre-download</em> 的阶段，也就是我们在 <em>verbose</em> 下看到的 <strong>Fetching external sources</strong> 过程。这个 <em>pre-download</em> 阶段<strong>不属于 Download</strong> 过程，而是在当前的 <em>依赖分析过程</em>。这里主要是解决当我们通过 git 地址引入的 Pod 仓的情况，系统无法从默认的 Source 拿到对应的 Spec，需要直接访问我们的 git 地址下载仓库的 zip 包，并取出对应的 <code class="highlighter-rouge">podspec</code> 文件，从而拿来分析。</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Sepicat 的 Podfile 解析结果</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">SnapKit</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">4.0</span><span class="o">.</span><span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">CocoaLumberjack</span><span class="o">/</span><span class="no">Swift</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">3.3</span><span class="o">.</span><span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="n">pop</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">1.0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Alamofire</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">4.5</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">ObjectMapper</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">3.1</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">AlamofireObjectMapper</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">5.0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">SDWebImage</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">4.0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">NVActivityIndicatorView</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">4.1</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">LTMorphingLabel</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">0.5</span><span class="o">.</span><span class="mi">3</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">ReachabilitySwift</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">KVOController</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">1.2</span><span class="o">.</span><span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">EFQRCode</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">4.3</span><span class="o">.</span><span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">PySwiftyRegex</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">2.0</span><span class="o">.</span><span class="mi">1</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">SwiftyUserDefaults</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="p">{</span><span class="ss">:git</span><span class="o">=&gt;</span><span class="s2">"https://github.com/Sepicat/SwiftyUserDefaults.git"</span><span class="p">}</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">AcknowList</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">1.5</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">MJRefresh</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">3.0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">SwiftMessages</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">4.1</span><span class="o">.</span><span class="mi">2</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">SkeletonView</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">1.2</span><span class="o">.</span><span class="mi">1</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">ViewAnimator</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mf">2.1</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Highlightr</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="p">{</span><span class="ss">:git</span><span class="o">=&gt;</span><span class="s2">"https://github.com/Sepicat/Highlightr.git"</span><span class="p">}</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">WCLShineButton</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="p">{</span><span class="ss">:git</span><span class="o">=&gt;</span><span class="s2">"https://github.com/Sepicat/WCLShineButton.git"</span><span class="p">}</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">ActiveLabel</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="p">{</span><span class="ss">:git</span><span class="o">=&gt;</span><span class="s2">"https://github.com/optonaut/ActiveLabel.swift.git"</span><span class="p">}</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">XLPagerTabStrip</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="p">{</span><span class="ss">:git</span><span class="o">=&gt;</span><span class="s2">"https://github.com/Sepicat/XLPagerTabStrip.git"</span><span class="p">}</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Fabric</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Crashlytics</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Firebase</span><span class="o">/</span><span class="no">Core</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Curiouscat</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="p">{</span><span class="ss">:git</span><span class="o">=&gt;</span><span class="s2">"https://github.com/Sepicat/Curiouscat.git"</span><span class="p">,</span> <span class="ss">:commit</span><span class="o">=&gt;</span><span class="s2">"9f3bb2c2440a7d11a5dd74255d0fee8e4a4cdb67"</span><span class="p">}</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Straycat</span> <span class="n">requirements</span><span class="o">=&gt;=</span> <span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="p">{</span><span class="ss">:path</span><span class="o">=&gt;</span><span class="s2">"./../../Straycat"</span><span class="p">}</span><span class="o">&gt;</span>
<span class="c1"># Sepicat 工程中各个 target 对应 spec 情况</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Podfile</span><span class="o">::</span><span class="no">TargetDefinition</span> <span class="n">label</span><span class="o">=</span><span class="no">Pods</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Podfile</span><span class="o">::</span><span class="no">TargetDefinition</span> <span class="n">label</span><span class="o">=</span><span class="no">Pods</span><span class="o">-</span><span class="no">Sepicat</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"AcknowList"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"ActiveLabel"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Alamofire"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"AlamofireObjectMapper"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"CocoaLumberjack/Default"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"CocoaLumberjack/Swift"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Crashlytics"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Curiouscat"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"EFQRCode"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Fabric"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Firebase/Core"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Firebase/CoreOnly"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"FirebaseAnalytics"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"FirebaseCore"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"FirebaseInstanceID"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"GoogleAppMeasurement"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"GoogleUtilities/AppDelegateSwizzler"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"GoogleUtilities/Environment"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"GoogleUtilities/Logger"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"GoogleUtilities/MethodSwizzler"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"GoogleUtilities/NSData+zlib"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"GoogleUtilities/Network"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"GoogleUtilities/Reachability"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Highlightr"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"KVOController"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Kanna"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"LTMorphingLabel"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"MJRefresh"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"NVActivityIndicatorView"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"NVActivityIndicatorView/Presenter"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"ObjectMapper"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"PySwiftyRegex"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"ReachabilitySwift"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"SDWebImage"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"SDWebImage/Core"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"SkeletonView"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"SnapKit"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"Straycat"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"SwiftMessages"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"SwiftMessages/App"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"SwiftSoup"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"SwiftyUserDefaults"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"ViewAnimator"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"WCLShineButton"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"XLPagerTabStrip"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"nanopb"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"nanopb/decode"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"nanopb/encode"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Specification</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"pop"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Podfile</span><span class="o">::</span><span class="no">TargetDefinition</span> <span class="n">label</span><span class="o">=</span><span class="no">Pods</span><span class="o">-</span><span class="no">SepicatTests</span><span class="o">&gt;</span></code></pre></figure>
<h4 id="按需下载依赖过程---download_dependencies">按需下载依赖过程 - <code class="highlighter-rouge">download_dependencies</code></h4>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">download_dependencies</span>
  <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Downloading dependencies'</span> <span class="k">do</span>
    <span class="c1"># 初始化 sandbox 文件访问器</span>
    <span class="n">create_file_accessors</span>
    <span class="c1"># 构造 Pod Source Installer</span>
    <span class="n">install_pod_sources</span>
    <span class="c1"># 执行 pre install 的 hooks</span>
    <span class="n">run_podfile_pre_install_hooks</span>
    <span class="c1"># 根据配置清理 pod sources 信息，主要是清理无用 platform 相关内容</span>
    <span class="n">clean_pod_sources</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>
<p>在这一步骤中，最重要的是 <code class="highlighter-rouge">install_pod_sources</code> 过程。<code class="highlighter-rouge">install_pod_sources</code> 过程会调用对应 Pod 的 <code class="highlighter-rouge">install!</code> 方法。在 <code class="highlighter-rouge">create_file_accessors</code> 中会创建 sandbox 目录的文件访问器，通过构造 <code class="highlighter-rouge">FileAccessor</code> 实例来解析沙盒中的各种文件。</p>
<p>接下来我们主要来看看 <code class="highlighter-rouge">install_pod_sources</code> 这个方法的实现：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">install_pod_sources</span>
  <span class="vi">@installed_specs</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="c1"># install 的 Pod 只需要这两种状态，added 和 changed 状态的并集</span>
  <span class="n">pods_to_install</span> <span class="o">=</span> <span class="n">sandbox_state</span><span class="p">.</span><span class="nf">added</span> <span class="o">|</span> <span class="n">sandbox_state</span><span class="p">.</span><span class="nf">changed</span>
  <span class="n">title_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:verbose_prefix</span> <span class="o">=&gt;</span> <span class="s1">'-&gt; '</span><span class="p">.</span><span class="nf">green</span> <span class="p">}</span>
  <span class="nb">puts</span> <span class="s2">"root_specs"</span>
  <span class="n">root_specs</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="n">item</span>
  <span class="k">end</span>
  <span class="c1"># 将 Podfile 解析后排序处理</span>
  <span class="n">root_specs</span><span class="p">.</span><span class="nf">sort_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">spec</span><span class="o">|</span>
    <span class="c1"># 如果是 added 状态或 changed 状态的 Pod</span>
    <span class="k">if</span> <span class="n">pods_to_install</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span>
      <span class="c1"># 如果是 changed 状态并且 manifest 已经有记录</span>
      <span class="k">if</span> <span class="n">sandbox_state</span><span class="p">.</span><span class="nf">changed</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sandbox</span><span class="p">.</span><span class="nf">manifest</span>
        <span class="c1"># 版本更新</span>
        <span class="n">current_version</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="nf">version</span>
        <span class="c1"># 被更新版本记录</span>
        <span class="n">previous_version</span> <span class="o">=</span> <span class="n">sandbox</span><span class="p">.</span><span class="nf">manifest</span><span class="p">.</span><span class="nf">version</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span>
        <span class="c1"># 变动记录</span>
        <span class="n">has_changed_version</span> <span class="o">=</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">previous_version</span>
        <span class="c1"># 找到第一个包含 spec.name 的 Pod，获取对应的 Repo，其实就是 find 方法</span>
        <span class="n">current_repo</span> <span class="o">=</span> <span class="n">analysis_result</span><span class="p">.</span><span class="nf">specs_by_source</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="o">|</span> <span class="k">break</span> <span class="n">key</span> <span class="k">if</span> <span class="n">values</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">).</span><span class="nf">include?</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="c1"># puts "current_repo : #{current_repo}"</span>
        <span class="c1"># puts "current_repo : #{current_repo.url}"</span>
        <span class="c1"># puts "current_repo : #{current_repo.name}"</span>
        <span class="c1"># 获取当前仓库</span>
        <span class="n">current_repo</span> <span class="o">&amp;&amp;=</span> <span class="n">current_repo</span><span class="p">.</span><span class="nf">url</span> <span class="o">||</span> <span class="n">current_repo</span><span class="p">.</span><span class="nf">name</span>
        <span class="c1"># 获取之前该仓库的信息</span>
        <span class="n">previous_spec_repo</span> <span class="o">=</span> <span class="n">sandbox</span><span class="p">.</span><span class="nf">manifest</span><span class="p">.</span><span class="nf">spec_repo</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span>
        <span class="c1"># 是否仓库有变动</span>
        <span class="n">has_changed_repo</span> <span class="o">=</span> <span class="o">!</span><span class="n">previous_spec_repo</span><span class="p">.</span><span class="nf">nil?</span> <span class="o">&amp;&amp;</span> <span class="n">current_repo</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current_repo</span> <span class="o">!=</span> <span class="n">previous_spec_repo</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">"Installing </span><span class="si">#{</span><span class="n">spec</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">spec</span><span class="p">.</span><span class="nf">version</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">title</span> <span class="o">&lt;&lt;</span> <span class="s2">" (was </span><span class="si">#{</span><span class="n">previous_version</span><span class="si">}</span><span class="s2"> and source changed to `</span><span class="si">#{</span><span class="n">current_repo</span><span class="si">}</span><span class="s2">` from `</span><span class="si">#{</span><span class="n">previous_spec_repo</span><span class="si">}</span><span class="s2">`)"</span> <span class="k">if</span> <span class="n">has_changed_version</span> <span class="o">&amp;&amp;</span> <span class="n">has_changed_repo</span>
        <span class="n">title</span> <span class="o">&lt;&lt;</span> <span class="s2">" (was </span><span class="si">#{</span><span class="n">previous_version</span><span class="si">}</span><span class="s2">)"</span> <span class="k">if</span> <span class="n">has_changed_version</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">has_changed_repo</span>
        <span class="n">title</span> <span class="o">&lt;&lt;</span> <span class="s2">" (source changed to `</span><span class="si">#{</span><span class="n">current_repo</span><span class="si">}</span><span class="s2">` from `</span><span class="si">#{</span><span class="n">previous_spec_repo</span><span class="si">}</span><span class="s2">`)"</span> <span class="k">if</span> <span class="o">!</span><span class="n">has_changed_version</span> <span class="o">&amp;&amp;</span> <span class="n">has_changed_repo</span>
      <span class="k">else</span>
        <span class="c1"># 非 changed 状态，展示 Installing 这个是经常见的</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">"Installing </span><span class="si">#{</span><span class="n">spec</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
      <span class="no">UI</span><span class="p">.</span><span class="nf">titled_section</span><span class="p">(</span><span class="n">title</span><span class="p">.</span><span class="nf">green</span><span class="p">,</span> <span class="n">title_options</span><span class="p">)</span> <span class="k">do</span>
        <span class="c1"># 通过 name 拿到对应的 installer，记录到 @pod_installers 中</span>
        <span class="n">install_source_of_pod</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="c1"># 如果没有 changed 情况，直接展示 Using ，也是经常见到的 log</span>
      <span class="no">UI</span><span class="p">.</span><span class="nf">titled_section</span><span class="p">(</span><span class="s2">"Using </span><span class="si">#{</span><span class="n">spec</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">title_options</span><span class="p">)</span> <span class="k">do</span>
        <span class="c1"># 通过文件获取到 installer 实例，记录到 @pod_installers 中</span>
        <span class="n">create_pod_installer</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="nf">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c1"># 通过缓存返回 PodSourceInstaller 实例</span>
<span class="k">def</span> <span class="nf">create_pod_installer</span><span class="p">(</span><span class="n">pod_name</span><span class="p">)</span>
  <span class="n">specs_by_platform</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">pod_targets</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pod_target</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">pod_target</span><span class="p">.</span><span class="nf">root_spec</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">pod_name</span>
      <span class="n">specs_by_platform</span><span class="p">[</span><span class="n">pod_target</span><span class="p">.</span><span class="nf">platform</span><span class="p">]</span> <span class="o">||=</span> <span class="p">[]</span>
      <span class="n">specs_by_platform</span><span class="p">[</span><span class="n">pod_target</span><span class="p">.</span><span class="nf">platform</span><span class="p">].</span><span class="nf">concat</span><span class="p">(</span><span class="n">pod_target</span><span class="p">.</span><span class="nf">specs</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="s2">"Could not install '</span><span class="si">#{</span><span class="n">pod_name</span><span class="si">}</span><span class="s2">' pod. There is no target that supports it."</span> <span class="k">if</span> <span class="n">specs_by_platform</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="vi">@pod_installers</span> <span class="o">||=</span> <span class="p">[]</span>
  <span class="c1"># 通过 sandbox, specs 的 platform 信息生成 Installer 实例</span>
  <span class="n">pod_installer</span> <span class="o">=</span> <span class="no">PodSourceInstaller</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">sandbox</span><span class="p">,</span> <span class="n">specs_by_platform</span><span class="p">,</span> <span class="ss">:can_cache</span> <span class="o">=&gt;</span> <span class="n">installation_options</span><span class="p">.</span><span class="nf">clean?</span><span class="p">)</span>
  <span class="vi">@pod_installers</span> <span class="o">&lt;&lt;</span> <span class="n">pod_installer</span>
  <span class="nb">puts</span> <span class="s2">"pod_installer -&gt;  </span><span class="si">#{</span><span class="n">pod_installer</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="s2">"specs_by_platform -&gt; </span><span class="si">#{</span><span class="n">specs_by_platform</span><span class="si">}</span><span class="s2">"</span>
  <span class="n">pod_installer</span>
<span class="k">end</span>
<span class="c1"># 安装 Pods。如果 resolver 声明一个 Pod 已经安装或者已经存在，</span>
<span class="c1"># 将会将其删除并重新安装。如果不存在则直接安装。</span>
<span class="c1">#</span>
<span class="c1"># @return [void]</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">install_source_of_pod</span><span class="p">(</span><span class="n">pod_name</span><span class="p">)</span>
  <span class="n">pod_installer</span> <span class="o">=</span> <span class="n">create_pod_installer</span><span class="p">(</span><span class="n">pod_name</span><span class="p">)</span>
  <span class="n">pod_installer</span><span class="p">.</span><span class="nf">install!</span>
  <span class="vi">@installed_specs</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">pod_installer</span><span class="p">.</span><span class="nf">specs_by_platform</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">flatten</span><span class="p">.</span><span class="nf">uniq</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>
<p><code class="highlighter-rouge">install_pod_sources</code> 总结下来，就是根据依赖分析的结果，通过 name 拿到所有依赖的 <code class="highlighter-rouge">installer</code> 实例。在方法的开始，<code class="highlighter-rouge">root_specs</code> 方法是通过 <code class="highlighter-rouge">analysis_result</code> 拿出所有根 spec。</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">root_specs</span>
  <span class="c1"># 会取出所有的 root spec</span>
  <span class="n">analysis_result</span><span class="p">.</span><span class="nf">specifications</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:root</span><span class="p">).</span><span class="nf">uniq</span>
<span class="k">end</span></code></pre></figure>
<p>下面再来看看 <code class="highlighter-rouge">install!</code> 到底做了什么工作。<strong>调用 <code class="highlighter-rouge">install!</code> 是所有生成 <code class="highlighter-rouge">Installer</code> 实例的目的</strong>。在 <code class="highlighter-rouge">pod_source_installer.rb</code> 中有 <code class="highlighter-rouge">install!</code> 方法的实现：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">install!</span>
  <span class="c1"># 如果未经历 pre-download 阶段或是 local 的 Pod，通过对应的 Source 下载</span>
  <span class="n">download_source</span> <span class="k">unless</span> <span class="n">predownloaded?</span> <span class="o">||</span> <span class="n">local?</span>
  <span class="c1"># 执行 Spec 中的 Preparer Command</span>
  <span class="no">PodSourcePreparer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">root_spec</span><span class="p">,</span> <span class="n">root</span><span class="p">).</span><span class="nf">prepare!</span> <span class="k">if</span> <span class="n">local?</span>
<span class="k">end</span></code></pre></figure>
<p>其实 <code class="highlighter-rouge">install!</code> 中主要就是将 Pod 通过对应的 Source 下载下来，其中会调用 <code class="highlighter-rouge">cocoapods-downloader</code> 组件来处理所有的下载逻辑。</p>
<h4 id="验证-target-流程---validate_targets">验证 Target 流程 - <code class="highlighter-rouge">validate_targets</code></h4>
<p><code class="highlighter-rouge">validate_targets</code> 过程用来验证之前流程中的产物 pod 所生成的 Targets 的合法性方法。这个方法只是简单的验证了一下。<code class="highlighter-rouge">validate_targets</code> 方法的主要作用就是构造 <code class="highlighter-rouge">TargetValidator</code>，并执行 <code class="highlighter-rouge">validate!</code> 方法：</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">validate_targets</span>
  <span class="c1"># puts "validate_targets -&gt; #{aggregate_targets}"</span>
  <span class="c1"># puts "pod_targets -&gt; #{pod_targets}"</span>
  <span class="c1"># aggregate 工程中的 Target</span>
  <span class="c1"># Pods 所有 Target</span>
  <span class="n">validator</span> <span class="o">=</span> <span class="no">Xcode</span><span class="o">::</span><span class="no">TargetValidator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">aggregate_targets</span><span class="p">,</span> <span class="n">pod_targets</span><span class="p">)</span>
  <span class="n">validator</span><span class="p">.</span><span class="nf">validate!</span>
<span class="k">end</span>
<span class="c1"># target_validator.rb </span>
<span class="k">def</span> <span class="nf">validate!</span>
  <span class="c1"># 重名检测</span>
  <span class="n">verify_no_duplicate_framework_and_library_names</span>
  <span class="c1"># framework 包裹的静态库检测</span>
  <span class="n">verify_no_static_framework_transitive_dependencies</span>
  <span class="c1"># 验证 Pod 中是否指明多个 Swift 版本</span>
  <span class="n">verify_no_pods_used_with_multiple_swift_versions</span>
  <span class="c1"># 验证 Swift 的 Pod 是否有 module 依赖</span>
  <span class="n">verify_swift_pods_have_module_dependencies</span>
<span class="k">end</span></code></pre></figure>
<p>验证环节在整个 Install 过程中仅占很小的一部分。因为只是验证部分，是完全解耦的。（我尝试过将整个 <code class="highlighter-rouge">validate_targets</code> 注释掉，<em>install</em> 过程）</p>
<ol>
  <li>
    <p><code class="highlighter-rouge">verify_no_duplicate_framework_and_library_names</code> 用来验证是否有重名的 <code class="highlighter-rouge">framework</code>，如果有冲突会直接抛出 <em>frameworks with conflicting names</em> 异常。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">verify_no_static_framework_transitive_dependencies</code> 用来验证动态库中是否有静态库或者 framework 静态库，如果有直接抛出异常。给定一个场景，如果 A 组件依赖 B 组件，B 组件中通过 <code class="highlighter-rouge">vendored_libraries</code> 加载的静态库(<code class="highlighter-rouge">.a</code> 或者 <code class="highlighter-rouge">.framework</code>)，如果此时使用了 <code class="highlighter-rouge">use_framework!</code>，打包的时候，<code class="highlighter-rouge">framework</code> 会将 <code class="highlighter-rouge">vendored_libraries</code> 中的内容包括进来，这要就在符号决议的时候产生冲突。但其实动态库中依赖静态库这是一种很常见的情况，所以在搜索引擎中检索异常 Log <code class="highlighter-rouge">transitive dependencies that include static binaries:</code> 可以查到很多对应解决方案，但主要方法是：</p>
    <ol>
      <li>修改 pod 库中 <code class="highlighter-rouge">podspec</code>，增加 <code class="highlighter-rouge">pod_target_xcconfig</code>，定义好 <code class="highlighter-rouge">FRAMEWORK_SEARCH_PATHS</code> 和 <code class="highlighter-rouge">OTHER_LDFLAGS</code> 两个环境变量；</li>
      <li>hook <code class="highlighter-rouge">verify_no_static_framework_transitive_dependencies</code> 的方法，将其干掉！<a href="https://github.com/CocoaPods/CocoaPods/issues/3289">对应 issue</a></li>
    </ol>
  </li>
</ol>
<blockquote>
  <p><code class="highlighter-rouge">vendored_libraries</code> 用来在 <code class="highlighter-rouge">spec</code> 文件中指定依赖的静态库，例如<em>微博 SDK</em> 中的 <code class="highlighter-rouge">s.vendored_libraries = 'libWeiboSDK/libWeiboSDK.a'</code>。</p>
</blockquote>
<ol>
  <li>
    <p><code class="highlighter-rouge">verify_swift_pods_have_module_dependencies</code> 用来检测 Swift 的 framework 中是否有 <em>Module Dependencies</em>，如果有的话需要检查这些依赖是否需要进行 <code class="highlighter-rouge">build</code>，判断的条件是：1. 是否有代码文件；2. 是否定义了 <code class="highlighter-rouge">module</code>。目前还没有明确的场景，笔者对 <em>Module Dependencies</em> 的定义也比较模糊，后续跟进；</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">verify_no_pods_used_with_multiple_swift_versions</code> 用来检测是否所有的 <em>Pod Target</em> 中版本一致性问题。</p>
  </li>
</ol>
<h4 id="工程文件生成---generate_pods_project">工程文件生成 - <code class="highlighter-rouge">generate_pods_project</code></h4>
<p>工程文件的生成是 <code class="highlighter-rouge">pod install</code> 的最后一步，他会将之前版本仲裁后的所有组件通过 Project 文件的形式组织起来，并且会对 Project 中做一些用户指定的配置。</p>
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">generate_pods_project</span><span class="p">(</span><span class="n">generator</span> <span class="o">=</span> <span class="n">create_generator</span><span class="p">)</span>
  <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Generating Pods project'</span> <span class="k">do</span>
    <span class="c1"># 执行 generator 的 generate 方法</span>
    <span class="c1"># 里面包含五步骤：</span>
    <span class="c1">#     1. prepare - 准备 Pod Project 的基础配置，也会组装 sandbox 中所有 Pod 的 path，组装 build setting 的基础配置</span>
    <span class="c1">#     2. install_file_references - 组装文件应用，其中包括源文件引用、framework 的 bundle、静态库文件、资源文件、链接头文件</span>
    <span class="c1">#     3. install_libraries - 对于所有的 Targets 和 Pod Targets 组装头文件的绝对路径</span>
    <span class="c1">#     4. integrate_targets - 整合 Targets，对 Targets 做一些配置</span>
    <span class="c1">#     5. set_target_dependencies - 对于每个 Target 增加 Pod 依赖关系，并完成链接</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">generate!</span>
    <span class="c1"># 取出 project 实例</span>
    <span class="vi">@pods_project</span> <span class="o">=</span> <span class="n">generator</span><span class="p">.</span><span class="nf">project</span>
    <span class="c1"># 执行 Podfile 中的 post_install 的 hook 方法</span>
    <span class="n">run_podfile_post_install_hooks</span>
    <span class="c1"># 保存生成的 Project 文件</span>
    <span class="c1"># 在保存之前也会做一些优化过程，例如会检测一下 Pods 是否为空，Dev Pods 是否为空，也会校验 Pods 工程文件中的所有文件的 Deterministic UUID 等</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">write</span>
    <span class="c1"># 将 Development 的 scheme 变成 share 状态</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">share_development_pod_schemes</span>
    <span class="c1"># 写 lock 文件</span>
    <span class="n">write_lockfiles</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>
<p>在 <code class="highlighter-rouge">install</code> 过程中，除去依赖仲裁部分和下载部分的时间消耗，在工程文件生成也会有相对较大的时间开销。这里往往也是速度优化核心位置。在最新的 <code class="highlighter-rouge">1.6.1</code> 版本中，这个环节被大量的重构优化，后续我们看以对比两个版本一探究竟。</p>
<h2 id="文件释义">文件释义</h2>
<ol>
  <li>
    <p><code class="highlighter-rouge">Podfile</code> - 由用户实现的关于 <em>Target</em> 与 Pod 关系的声明规范。<strong>注意，这里有 <em>Target</em> 和 Pod 的关系，这些是 <code class="highlighter-rouge">Podfile.lock</code> 中无法拿到的。</strong></p>
  </li>
  <li>
    <p><code class="highlighter-rouge">Podfile.lock</code> - 包括安装 Pod 的所有信息，对应 Pod 的版本号、Git 地址、Branch 信息、Commit 信息、Tag 信息（Git、Branch、Commit、Tag 均为 Git Label 依赖）、Local Path 信息（Development Pod 模式）。也包含了所有 Pod 的<strong>最终决议版本</strong>、<strong>二级子依赖列表</strong>、<strong>使用的 Source</strong>、<strong>spec 文件的 Checksum</strong>。</p>
  </li>
</ol>
<blockquote>
  <ul>
    <li>这里的 <em>Checksum</em> 可以理解成是一个文件的 MD5 编码，不同文件的 Checksum 不同。在 <em>CocoaPods 1.5.3</em> 和 <em>Cocoapods 1.6.1</em> 中，<strong>Sepc 文件的 Checksum</strong>发生了变化，由之前的原文件变成了 spec 序列化之后的 json 文件的 MD5，这个后续系列文中会讲到。</li>
    <li>Source 的意思是对应 spec 仓库的 Git 地址。一般大厂中往往会自己维护一个或多个 spec 仓库，从而有利于组件版本的控制。</li>
  </ul>
</blockquote>
<ol>
  <li><code class="highlighter-rouge">Manifest.lock</code> - <code class="highlighter-rouge">Pods</code> 目录中包含的文件，用于跟踪本地安装的 Pod。如果在 <code class="highlighter-rouge">install</code> 过程中检查到与之前的缓存相同就会直接使用缓存版本，而其根据就是 <code class="highlighter-rouge">Manifest.lock</code> 文件。在每次 <code class="highlighter-rouge">install</code> 完毕后，<code class="highlighter-rouge">Manifest.lock</code> 会被重写成最新的 <code class="highlighter-rouge">Podfile.lock</code> 文件。</li>
</ol>
<h2 id="结语">结语</h2>
<p>当我们知道 CocoaPods 在 <code class="highlighter-rouge">install</code> 的大致过程后，我们可以对其做一些修改和控制。例如知道了 <code class="highlighter-rouge">pre_install</code> 和 <code class="highlighter-rouge">post_install</code> 的具体时机，我们就可以在 <code class="highlighter-rouge">Podfile</code> 中执行对应的 Ruby 脚本，达到我们的预期。</p>
<p>后续，学习 CocoaPods 中每一个组件的实现，将所有的问题在代码中找到答案。</p>
  <footer class="post-footer">
    <section class="author">
      <h4>Desgard_Duan</h4>
      <p>I write many code to write less code.💻</p>
    </section>
<aside class="share">
  <h4>Share this.</h4>
  <a href="http://twitter.com/share?text=《CocoaPods 历险 - 总览》 -- Guardia · 瓜地&amp;url=https://www.desgard.com/cocoapods-1/"
  onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
    <i class="fa fa-twitter-square"></i>
  </a>
  <a href="http://v.t.sina.com.cn/share/share.php?url=https://www.desgard.com/cocoapods-1/&amp;title=《CocoaPods 历险 - 总览》 —— Guardia · 瓜地" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
    <i class="fa fa-weibo"></i>
  </a>
</aside>
      <aside id="comments" class="disqus">
  <div id="container"></div>
  <link rel="stylesheet" href="/assets/css/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <div id='gitalk-container'></div>
  <script>
    const gitalk = new Gitalk({
      id: "https://www.desgard.com/cocoapods-1/",
      clientID: 'e2612df42f3f2a83e71c',
      clientSecret: 'b53e85b314bb24a6d06773e48bbb62a4de3b8b3a',
      repo: 'desgard.github.com',
      owner: 'Desgard',
      admin: ['Desgard'],
      // facebook-like distraction free mode
      distractionFreeMode: false
    })
    gitalk.render('gitalk-container')
  </script>
</aside>
  </footer>
</article>
    </main>
<footer class="footer">
  <div class="container">
    <ul class="icons">
      <li>
        <a href="https://github.com/desgard" class="icon-github" target="_blank">
          <i class="fa fa-github"></i>
        </a>
      </li>
      <li>
        <a href="https://www.facebook.com/desgard.duan" class="icon-facebook" target="_blank">
          <i class="fa fa-facebook"></i>
        </a>
      </li>
      <li>
        <a href="https://twitter.com/Desgard_Duan" class="icon-twitter" target="_blank">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
      <li>
        <a href="https://stackoverflow.com/users/6119149/desgard-duan" class="icon-github" target="_blank">
          <i class="fa fa-stack-overflow"></i>
        </a>
      </li>
      <li>
        <a href="https://weibo.com/desgard" class="icon-instagram" target="_blank">
          <i class="fa fa-weibo"></i>
        </a>
      </li>
    </ul>
    <p>
      <q>I write many code to write less code.💻</q>
      <small>– Gua</small>
    </p>
    <small class="clearfix">
      Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a> • <a href="https://github.com/desgard" target="_blank">Open source <i class="fa fa-heart"></i></a>
    </small>
  </div>
</footer>
<a class="scroll-up fa fa-chevron-up bounce" href="#" data-position="0"></a>
    <div id="modalSearch" class="modal">
  <div class="modal__overlay"></div>
  <div class="modal__content">
    <a href="#" class="modal-close" onclick="show_search_view(false)">&times;</a>
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search articles">
      <ul id="results-container"></ul>
    </div>
  </div>
</div>
<!-- Configuration -->
<script>
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('results-container'),
    json: '/search.json'
  })
  function show_search_view(is_show) {
    var search_view = document.getElementById("modalSearch");
    search_view.className = is_show ? "modal modal--open" : "modal";
  }
</script>
  </body>
  <script>
    var link = "" ;
    var os = function() {  
      var ua = navigator.userAgent,  
      isWindowsPhone = /(?:Windows Phone)/.test(ua),  
      isSymbian = /(?:SymbianOS)/.test(ua) || isWindowsPhone,   
      isAndroid = /(?:Android)/.test(ua),   
      isFireFox = /(?:Firefox)/.test(ua),   
      isChrome = /(?:Chrome|CriOS)/.test(ua),  
      isTablet = /(?:iPad|PlayBook)/.test(ua) || (isAndroid && !/(?:Mobile)/.test(ua)) || (isFireFox && /(?:Tablet)/.test(ua)),  
      isPhone = /(?:iPhone)/.test(ua) && !isTablet,  
      isPc = !isPhone && !isAndroid && !isSymbian;  
      return {  
        isTablet: isTablet,  
        isPhone: isPhone,  
        isAndroid : isAndroid,  
        isPc : isPc  
      };  
    }();  
    if (link.length > 0) {
      if (os.isAndroid || os.isPhone) {
        location.replace(link);
      }
    }
  </script>
</html>